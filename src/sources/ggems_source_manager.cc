/*!
  \file ggems_source_manager.cc

  \brief GGEMS class managing the source in GGEMS, every new sources in GGEMS
  inherit from this class

  \author Julien BERT <julien.bert@univ-brest.fr>
  \author Didier BENOIT <didier.benoit@inserm.fr>
  \author LaTIM, INSERM - U1101, Brest, FRANCE
  \version 1.0
  \date Tuesday October 15, 2019
*/

#include <algorithm>

#include "GGEMS/sources/ggems_source_manager.hh"
#include "GGEMS/tools/print.hh"
#include "GGEMS/global/ggems_constants.hh"
#include "GGEMS/tools/functions.hh"

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

GGEMSSourceManager* GGEMSSourceManager::p_current_source_ = nullptr;

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

GGEMSSourceManager::GGEMSSourceManager()
: is_initialized_(false),
  particle_type_(-1)
{
  GGEMScout("GGEMSSourceManager", "GGEMSSourceManager", 1)
    << "Allocation of GGEMSSourceManager..." << GGEMSendl;

  // Initialization of parameters
  pos_.s[0] = 0.0f;
  pos_.s[1] = 0.0f;
  pos_.s[2] = 0.0f;

  // Storing the pointer
  p_current_source_ = this;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

GGEMSSourceManager::~GGEMSSourceManager(void)
{
  GGEMScout("GGEMSSourceDefinition", "~GGEMSSourceDefinition", 1)
    << "Deallocation of GGEMSSourceDefinition..." << GGEMSendl;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

void GGEMSSourceManager::DeleteInstance(void)
{
  if (p_current_source_)
  {
    delete p_current_source_;
    p_current_source_ = nullptr;
  }
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool GGEMSSourceManager::IsReady(void) const
{
  return is_initialized_;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

void GGEMSSourceManager::SetPosition(float const& pos_x, float const& pos_y,
  float const& pos_z)
{
  pos_.s[0] = pos_x;
  pos_.s[1] = pos_y;
  pos_.s[2] = pos_z;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

void GGEMSSourceManager::SetParticleType(char const* particle_type)
{
  // Convert the particle type in string
  std::string particle_type_str(particle_type);

  // Transform the string to lower character
  std::transform(particle_type_str.begin(), particle_type_str.end(),
    particle_type_str.begin(), ::tolower);

  if (!particle_type_str.compare("photon")) {
    particle_type_ = ParticleName::PHOTON;
  }
  else if (!particle_type_str.compare("electron")) {
    particle_type_ = ParticleName::ELECTRON;
  }
  else
  {
    Misc::ThrowException("GGEMSSourceManager", "SetParticleType",
      "Unknown particle!!!");
  }
}
