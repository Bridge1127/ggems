/*!
  \file particles.cc

  \brief Class managing the particles in GGEMS

  \author Julien BERT <julien.bert@univ-brest.fr>
  \author Didier BENOIT <didier.benoit@inserm.fr>
  \author LaTIM, INSERM - U1101, Brest, FRANCE
  \version 1.0
  \date Thrusday October 3, 2019
*/

#include "GGEMS/processes/particles.hh"
#include "GGEMS/processes/primary_particles.hh"

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

Particle::Particle(void)
: p_primary_particles_(nullptr),
  opencl_manager_(OpenCLManager::GetInstance())
{
  GGEMScout("Particle", "Particle", 3)
    << "Allocation of Particle..." << GGEMSendl;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

Particle::~Particle(void)
{
  // Freeing the device buffer
  if (p_primary_particles_) {
    opencl_manager_.Deallocate(p_primary_particles_, sizeof(PrimaryParticles));
    p_primary_particles_ = nullptr;
  }

  GGEMScout("Particle", "~Particle", 3)
    << "Deallocation of Particle..." << GGEMSendl;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

void Particle::Initialize(void)
{
  GGEMScout("Particle", "Initialize", 1)
    << "Initialization of Particle..." << GGEMSendl;

  // Allocation of the PrimaryParticle structure
  AllocatePrimaryParticles();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

void Particle::AllocatePrimaryParticles(void)
{
  GGEMScout("Particle", "AllocatePrimaryParticles", 1)
    << "Allocation of primary particles..." << GGEMSendl;

  // Allocation of memory on OpenCL device
  p_primary_particles_ = opencl_manager_.Allocate(nullptr,
    sizeof(PrimaryParticles), CL_MEM_READ_WRITE);
}
